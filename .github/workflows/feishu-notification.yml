name: é£ä¹¦æœºå™¨äººé€šçŸ¥

on:
  push:
    branches: [ main, master, develop, feature/*, hotfix/*, release/* ]
  pull_request:
    branches: [ main, master, develop ]
  create:
  delete:
  fork:
  gollum:
  issues:
  issue_comment:
  watch:
  release:
  deployment:
  deployment_status:
  public:
  repository_dispatch:

jobs:
  notify-feishu:
    runs-on: ubuntu-latest
    steps:
      - name: è·å–äº‹ä»¶ä¿¡æ¯
        id: event_info
        run: |
          echo "event_name=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          echo "ref_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "repository=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "actor=${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "workflow=${{ github.workflow }}" >> $GITHUB_OUTPUT
          
          # è·å–æäº¤ä¿¡æ¯ - ä½¿ç”¨GitHubç¯å¢ƒå˜é‡
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "commit_message=${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
            echo "commit_author=${{ github.event.head_commit.author.name }}" >> $GITHUB_OUTPUT
            echo "commit_date=${{ github.event.head_commit.timestamp }}" >> $GITHUB_OUTPUT
          fi
          
          # è·å–PRä¿¡æ¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
            echo "pr_body=${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
            echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          fi

      - name: å‘é€é£ä¹¦é€šçŸ¥
        run: |
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          PROJECT_NAME="1s"
          EVENT_NAME="${{ steps.event_info.outputs.event_name }}"
          BRANCH="${{ steps.event_info.outputs.ref_name }}"
          REPOSITORY="${{ steps.event_info.outputs.repository }}"
          ACTOR="${{ steps.event_info.outputs.actor }}"
          SHA="${{ steps.event_info.outputs.sha }}"
          
          # æ ¹æ®äº‹ä»¶ç±»å‹æ„å»ºä¸åŒçš„æ¶ˆæ¯
          case $EVENT_NAME in
            "push")
              COMMIT_MSG="${{ steps.event_info.outputs.commit_message }}"
              COMMIT_AUTHOR="${{ steps.event_info.outputs.commit_author }}"
              COMMIT_DATE="${{ steps.event_info.outputs.commit_date }}"
              
              # å¦‚æœæäº¤ä¿¡æ¯ä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
              if [ -z "$COMMIT_MSG" ]; then
                COMMIT_MSG="æ— æäº¤ä¿¡æ¯"
              fi
              if [ -z "$COMMIT_AUTHOR" ]; then
                COMMIT_AUTHOR="$ACTOR"
              fi
              if [ -z "$COMMIT_DATE" ]; then
                COMMIT_DATE="æœªçŸ¥æ—¶é—´"
              fi
              
              MESSAGE="ğŸš€ ä»£ç æ¨é€é€šçŸ¥\n\nğŸ“ é¡¹ç›®: $PROJECT_NAME\nğŸŒ¿ åˆ†æ”¯: $BRANCH\nğŸ‘¤ æäº¤è€…: $ACTOR\nğŸ“ æäº¤ä¿¡æ¯: $COMMIT_MSG\nğŸ‘¨â€ğŸ’» ä½œè€…: $COMMIT_AUTHOR\nğŸ“… æäº¤æ—¶é—´: $COMMIT_DATE\nğŸ”— ä»“åº“: https://github.com/$REPOSITORY\nğŸ”— æäº¤é“¾æ¥: https://github.com/$REPOSITORY/commit/$SHA"
              ;;
              
            "pull_request")
              PR_TITLE="${{ steps.event_info.outputs.pr_title }}"
              PR_BODY="${{ steps.event_info.outputs.pr_body }}"
              PR_AUTHOR="${{ steps.event_info.outputs.pr_author }}"
              
              MESSAGE="ğŸ”€ Pull Request é€šçŸ¥\n\nğŸ“ é¡¹ç›®: $PROJECT_NAME\nğŸŒ¿ åˆ†æ”¯: $BRANCH\nğŸ‘¤ åˆ›å»ºè€…: $PR_AUTHOR\nğŸ“ PRæ ‡é¢˜: $PR_TITLE\nğŸ“„ PRæè¿°: $PR_BODY\nğŸ”— ä»“åº“: https://github.com/$REPOSITORY\nğŸ”— PRé“¾æ¥: ${{ github.event.pull_request.html_url }}"
              ;;
              
            "create")
              MESSAGE="âœ¨ åˆ†æ”¯åˆ›å»ºé€šçŸ¥\n\nğŸ“ é¡¹ç›®: $PROJECT_NAME\nğŸŒ¿ åˆ†æ”¯: $BRANCH\nğŸ‘¤ åˆ›å»ºè€…: $ACTOR\nğŸ”— ä»“åº“: https://github.com/$REPOSITORY"
              ;;
              
            "delete")
              MESSAGE="ğŸ—‘ï¸ åˆ†æ”¯åˆ é™¤é€šçŸ¥\n\nğŸ“ é¡¹ç›®: $PROJECT_NAME\nğŸŒ¿ åˆ†æ”¯: $BRANCH\nğŸ‘¤ åˆ é™¤è€…: $ACTOR\nğŸ”— ä»“åº“: https://github.com/$REPOSITORY"
              ;;
              
            *)
              MESSAGE="ğŸ“¢ Gitäº‹ä»¶é€šçŸ¥\n\nğŸ“ é¡¹ç›®: $PROJECT_NAME\nğŸŒ¿ åˆ†æ”¯: $BRANCH\nğŸ‘¤ æ“ä½œè€…: $ACTOR\nğŸ“‹ äº‹ä»¶ç±»å‹: $EVENT_NAME\nğŸ”— ä»“åº“: https://github.com/$REPOSITORY"
              ;;
          esac
          
          # å‘é€åˆ°é£ä¹¦æœºå™¨äºº - ä½¿ç”¨textæ ¼å¼
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"$MESSAGE\"
              }
            }" \
            "https://open.feishu.cn/open-apis/bot/v2/hook/143ed889-eace-42df-ba97-d8b2bac28e6d")
          
          # æ£€æŸ¥å“åº”
          HTTP_CODE="${RESPONSE: -3}"
          RESPONSE_BODY="${RESPONSE%???}"
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $HTTP_CODE"
            echo "å“åº”å†…å®¹: $RESPONSE_BODY"
            exit 1
          else
            echo "âœ… é£ä¹¦é€šçŸ¥å‘é€æˆåŠŸ"
          fi 